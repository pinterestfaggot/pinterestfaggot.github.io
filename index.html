<!DOCTYPE html>
<html>

<head>
    <title>Roupinhas :3</title>
    <link href="style.css" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="48x48" href="thumb.png">
    <script type="module" defer>
        "use strict";
        const is_dev = location.hostname === "localhost" || location.href.includes("file://");
        const src = (is_dev) ? "https://esm.run/vue@3/dist/vue.esm-browser.js" : "https://esm.run/vue@3/dist/vue.esm-browser.prod.js"
        const { createApp, reactive, computed } = await import(src);



const tipos = ["Capacete","Bon√©","Blusa","Top","Casaco","Cropped","Luvas","Suti√£","Saia","Vestido","Minissaia","Shorts","Cal√ßas","Meias","Adere√ßo","Conjuntinho"];

        let usuarios = reactive({});

        let produtos = reactive([]);

        let conjuntinhos = reactive([]);

        let itens = computed(() => produtos.concat(conjuntinhos));

        let ids_por_ordem = reactive([]);

        let recomendacoes_por_usuario = reactive({});

        function pluralizar(singular, plural, quantia) {
            if (quantia == 1) return singular;
            return plural;
        }

        class usuario {
            cor = "#00ccccc";
            id = 0n;
            nome = "";
            constructor(cor, id, nome) {
                let str = '00ccccc';
                switch (cor.length) {
                    case 7:
                        str = cor;
                        break;
                    case 6:
                        str = "#" + cor;
                        break;
                    case 4:
                        str = cor[0] + cor[1] + cor[1] + cor[2] + cor[2] + cor[3] + cor[3];
                        break;
                    case 3:
                        str = "#" + cor[0] + cor[0] + cor[1] + cor[1] + cor[2] + cor[2];
                        break;
                    default:
                        console.log("%cCriado com cor #00ccccc", "color:#00cccc;");
                        str = "#00cccc"
                        break;
                }
                this.cor = str.toLowerCase();
                this.nome = nome;
                this.id = id;
                usuarios[id] = this;
            }
        }

        class Produto {
            tipo = "";
            url = { produto: "", imagem: "" };
            preco = 0;
            recomendador = 0n;
            descricao = "";
            constructor(tipo, url, preco, recomendador, descricao) {
                if (tipos.includes(tipo)) {
                    this.tipo = tipo;
                }
                else {
                    throw new ReferenceError("\nProduto de tipo inv√°lido.");
                }
                if (usuarios.hasOwnProperty(recomendador)) {
                    this.recomendador = recomendador
                }
                else {
                    throw new ReferenceError("ID de usu√°rio recomendador inv√°lido");
                }
                this.url = url;
                this.preco = preco;
                this.descricao = descricao;
            };

            toJSON() {
                return { "tipo": this.tipo, "url": { "produto": this.url.produto, "imagem": this.url.imagem }, "preco": this.preco.toString(), "recomendador": this.recomendador.toString(), "descricao": this.descricao };
            };

            static fromJSON(json) {
                return new Produto(json.tipo, { "produto": json.url.produto, "imagem": json.url.imagem }, Number(json.preco), BigInt(json.recomendador), json.descricao)
            };
        }

        class Conjuntinho extends Produto {
            partes = [""];
            constructor(url, preco, recomendador, descricao, partes) {
                super("Conjuntinho", url, preco, recomendador, descricao);
                let invalidas = [];
                for (let parte of partes) {
                    if (tipos.includes(parte) == false || parte == "Conjuntinho") {
                        invalidas.push(parte);
                    }
                    if (invalidas.length) {
                        console.log(partes);
                        if (invalidas.length == 1) throw new Error(`\nParte inv√°lida: ${invalidas[0]}`);
                        else throw new Error(`\nPartes inv√°lidas: ${invalidas.join(", ")}`);
                    }
                    this.partes = partes;
                }
            }

            toJSON() {
                return { "tipo": this.tipo, "url": { "produto": this.url.produto, "imagem": this.url.imagem }, "preco": this.preco.toString(), "recomendador": this.recomendador.toString(), "descricao": this.descricao, partes: this.partes.join(",") };
            };

            static fromJSON(json) {
                // constructor(url, preco, recomendador, descricao, partes)
                return new Conjuntinho({ "produto": json.url.produto, "imagem": json.url.imagem }, Number(json.preco), BigInt(json.recomendador), json.descricao, json.partes?.split(",") || [])
            };

        }


        createApp({
            data() {
                return {
                    usuarios,
                    produtos,
                    conjuntinhos,
                    itens,
                    ids_por_ordem,
                    recomendacoes_por_usuario,
                    pluralizar,
                    // UI state
                    modalVisible: false,
                    form: {
                        tipo: tipos[0] || '',
                        descricao: '',
                        produto: '',
                        imagem: '',
                        preco: '',
                        recomendadorName: '',
                        recomendadorColor: ''
                    },
                    errors: {}
                }
            },
            methods: {
                openModal() { this.modalVisible = true; this.errors = {}; },
                closeModal() { this.modalVisible = false; this.resetForm(); },
                resetForm() {
                    this.form = { tipo: tipos[0] || '', descricao: '', produto: '', imagem: '', preco: '', recomendadorName: '', recomendadorColor: '' };
                    this.errors = {};
                },
                isValidUrl(u) {
                    try { const url = new URL(u); return ['http:','https:'].includes(url.protocol); } catch(e){ return false; }
                },
                findUserByName(name){
                    if(!name) return null;
                    for(const k of Object.keys(this.usuarios)){
                        const u = this.usuarios[k];
                        if(u.nome === name) return u;
                    }
                    return null;
                },
                addOrReplaceUser(name, color){
                    // if exists by name, replace name/color and return id
                    const existing = this.findUserByName(name);
                    if(existing) { existing.nome = name; existing.cor = (color||existing.cor).toLowerCase(); return existing.id; }
                    // generate a stable-ish id
                    const id = BigInt(Date.now().toString() + String(Math.floor(Math.random()*1000))).valueOf();
                    new usuario(color || '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'), BigInt(id), name);
                    return BigInt(id);
                },
                submitNewItem(){
                    this.errors = {};
                    if(!this.form.produto || !this.isValidUrl(this.form.produto)) this.errors.produto = 'Link do produto inv√°lido.';
                    if(!this.form.imagem || !this.isValidUrl(this.form.imagem)) this.errors.imagem = 'Link de imagem inv√°lido.';
                    if(!this.form.descricao) this.errors.descricao = 'Descri√ß√£o √© obrigat√≥ria.';
                    if(Object.keys(this.errors).length) return;

                    // ensure user exists or create
                    const name = this.form.recomendadorName || 'An√¥nimo';
                    const color = this.form.recomendadorColor || '#00cccc';
                    const uid = this.addOrReplaceUser(name, color);

                    const preco = Number(parseFloat(this.form.preco || 0));

                    if(this.form.tipo === 'Conjuntinho'){
                        // assume partes provided in descricao field or optional (ask user to separate with commas?)
                        const partes = (this.form.partes || '').split(',').map(s=>s.trim()).filter(Boolean);
                        // if partes empty, create simple Conjuntinho with a default
                        const p = new Conjuntinho({produto:this.form.produto, imagem:this.form.imagem}, preco, uid, this.form.descricao, partes.length?partes:['Conjuntinho']);
                        this.conjuntinhos.push(p);
                    } else {
                        const p = new Produto(this.form.tipo, {produto:this.form.produto, imagem:this.form.imagem}, preco, uid, this.form.descricao);
                        this.produtos.push(p);
                    }

                    this.saveState();
                    this.closeModal();
                    // recompute order
                    this.recomputeTop3();
                },
                saveState(){
                    try{
                        const key = location.pathname.includes('/guloso') ? 'guloso_app_v1' : 'root_app_v1';
                        const usersArr = Object.values(this.usuarios).map(u=>({ id: String(u.id), nome: u.nome, cor: u.cor }));
                        const prodArr = this.produtos.map(p=>p.toJSON()).concat(this.conjuntinhos.map(c=>c.toJSON()));
                        localStorage.setItem(key, JSON.stringify({ users: usersArr, produtos: prodArr }));
                    }catch(e){console.warn('save failed', e)}
                },
                removeItem(item){
                    if(!confirm('Remover este item?')) return;
                    const pIndex = this.produtos.indexOf(item);
                    if(pIndex !== -1) { this.produtos.splice(pIndex,1); this.saveState(); this.recomputeTop3(); return; }
                    const cIndex = this.conjuntinhos.indexOf(item);
                    if(cIndex !== -1) { this.conjuntinhos.splice(cIndex,1); this.saveState(); this.recomputeTop3(); return; }
                },
                recomputeTop3(){
                    // reset and compute recomandations
                    for (let key of Object.keys(recomendacoes_por_usuario)) delete recomendacoes_por_usuario[key];
                    for(let item of this.itens){
                        if(!Object.keys(recomendacoes_por_usuario).includes(String(item.recomendador))) recomendacoes_por_usuario[item.recomendador]=0;
                        recomendacoes_por_usuario[item.recomendador]++;
                    }
                    ids_por_ordem.splice(0, ids_por_ordem.length);
                    for(let key of Object.keys(recomendacoes_por_usuario)) ids_por_ordem.push(key);
                    let sorted = ids_por_ordem.sort((a,b)=>{return recomendacoes_por_usuario[String(a)]-recomendacoes_por_usuario[String(b)]});
                    while(sorted.length>3) sorted.pop();
                    sorted.reverse();
                    // copy back
                    ids_por_ordem.splice(0, ids_por_ordem.length, ...sorted);
                }
            }
        }).mount("#vue");

        // Testing

        if (is_dev) {
            window.tipos = tipos;
            window.usuario = usuario;
            window.produto = Produto;
            window.conjuntinho = Conjuntinho;
            window.usuarios = usuarios;
            window.produtos = produtos;
            window.conjuntinhos = conjuntinhos;
            window.itens = itens;
            window.ids_por_ordem = ids_por_ordem;
            window.recomendacoes_por_usuario = recomendacoes_por_usuario;
            //usuarios[0n]={}
        }

            // load initial data: try localStorage first, else try fetching seed JSON files
        async function loadInitialData() {
            const key = location.pathname.includes('/guloso') ? 'guloso_app_v1' : 'root_app_v1';

            // try load from localStorage
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    const data = JSON.parse(stored);
                    // load users
                    if (Array.isArray(data.users)) {
                        for (let u of data.users) {
                            // ensure id is string for index; convert to BigInt when using
                            new usuario(u.cor || '#00cccc', BigInt(u.id), u.nome || '');
                        }
                    }
                    // load produtos
                    if (Array.isArray(data.produtos)) {
                        for (let p of data.produtos) {
                            if (p.tipo === 'Conjuntinho') {
                                conjuntinhos.push(Conjuntinho.fromJSON(p));
                            } else {
                                produtos.push(Produto.fromJSON(p));
                            }
                        }
                    }
                    return;
                }
            } catch (e) {
                console.warn('localStorage read failed', e);
            }

            // try fetch seed files
            try {
                const [usersResp, produtosResp] = await Promise.all([
                    fetch('users.json').then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch('produtos.json').then(r => r.ok ? r.json() : null).catch(() => null)
                ]);

                if (usersResp && Array.isArray(usersResp.users)) {
                    for (let u of usersResp.users) new usuario(u.cor || '#00cccc', BigInt(u.id), u.nome || '');
                } else {
                    // fallback defaults
                    new usuario('#E81F63', 1019164961206960150n, 'Odani');
                    new usuario('#FF0000', 1367721233738633329n, 'Slimmiest of Shadys :3');
                    new usuario('#1f99c5', 1423669363411783700n, 'Geladeira Ovo');
                    new usuario('#000000', -1n, 'An√¥nimo');
                }

                if (produtosResp && Array.isArray(produtosResp.produtos)) {
                    for (let p of produtosResp.produtos) {
                        if (p.tipo === 'Conjuntinho') conjuntinhos.push(Conjuntinho.fromJSON(p));
                        else produtos.push(Produto.fromJSON(p));
                    }
                }

                // after loading data (from localStorage or seeds) compute the top-3 users
                // reset frequency map then recompute
                for (let key of Object.keys(recomendacoes_por_usuario)) delete recomendacoes_por_usuario[key];
                for (let item of itens.value) {
                    if (Object.keys(recomendacoes_por_usuario).includes(item.recomendador.toString()) == false) recomendacoes_por_usuario[item.recomendador] = 0;
                    recomendacoes_por_usuario[item.recomendador]++;
                }
                ids_por_ordem.splice(0, ids_por_ordem.length);
                for (let key of Object.keys(recomendacoes_por_usuario)) ids_por_ordem.push(key);
                let sorted = ids_por_ordem.sort((a, b) => { return recomendacoes_por_usuario[String(a)] - recomendacoes_por_usuario[String(b)] });
                while (sorted.length > 3) sorted.pop();
                sorted.reverse();
                ids_por_ordem.splice(0, ids_por_ordem.length, ...sorted);
            } catch (e) {
                console.warn('fetching seeds failed', e);
            }
        }

        loadInitialData();



        //FIM DOS PRODUTOS, HORA DOS CONJUNTINHOS

        /*
        Template:
        
        conjuntinhos.push(new Conjuntinho
        {"produto":"",
        "imagem":""}
        ,0.00,0n,"Desc",["Tipo1","Tipo2"]));
        
        */

        // initial data comes from JSON seeds or localStorage, manual pushes removed


// top-3 calculation handled by loadInitialData() and recomputeTop3() on changes



    </script>
</head>

<body>
    <div id="vue">
        <!-- floating add button -->
        <button class="add-btn" @click="openModal" title="Indicar produto">‚ûï Indicar</button>
        <span style="color: #00493e; font-weight: bold; font-size: calc(1vmax + 1vmin);">Top 3 Usu√°rios:</span>

        <div v-for="(id,index) in Object.values(ids_por_ordem)">
            <span
                :style="{color:['#FEE101','#A7A7AD','#CD7F32'].at(index),fontSize:`calc(1vmax + ${0.5 - index * 0.25}vmin)`}"
                style="font-weight: bold;">
                {{ index+1 }}¬∞ lugar:
                <span :style="{color: usuarios[id].cor}">{{usuarios[id].nome}}</span>
                - {{ recomendacoes_por_usuario[id] }} Recomenda√ß{{pluralizar("√£o","√µes",recomendacoes_por_usuario[id])}}
            </span>
        </div>

        <br>

        <div class="container">
            <div v-for="item in itens" class="box">
                {{item.descricao}}<br>
                Recomendado por: <span style="font-weight: bold;"
                    :style="{color: usuarios[item.recomendador].cor}">{{usuarios[item.recomendador].nome}}</span><br>
                <a :href="item.url.produto" target="_blank">Clique aqui para comprar</a> (R${{item.preco.toFixed(2)}})
                <br>
                <a :href="item.url.produto" target="_blank">
                    <img :src="item.url.imagem" style="max-width: calc(12vmin + 12vmax); max-height:calc(20vmin + 20vmax);">
                </a>
                <button class="remove-btn" @click="removeItem(item)" title="Remover">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Modal: add new product -->
        <div v-if="modalVisible" class="modal-overlay" @click.self="closeModal">
            <div class="modal">
                <h3>Indicar produto</h3>
                <label>Tipo
                    <select v-model="form.tipo">
                        <option v-for="t in Object.freeze(tipos)" :value="t">{{t}}</option>
                    </select>
                </label>

                <label>Descri√ß√£o
                    <input v-model="form.descricao" placeholder="Breve descri√ß√£o" />
                </label>

                <label>Link do produto
                    <input v-model="form.produto" placeholder="https://..." />
                    <div class="error" v-if="errors.produto">{{errors.produto}}</div>
                </label>

                <label>Link da imagem
                    <input v-model="form.imagem" placeholder="https://..." />
                    <div class="error" v-if="errors.imagem">{{errors.imagem}}</div>
                </label>

                <label>Pre√ßo
                    <input v-model="form.preco" placeholder="0.00" type="number" step="0.01" />
                </label>

                <label>Recomendador (nome)
                    <input v-model="form.recomendadorName" placeholder="Seu nome" />
                </label>

                <label>Cor (hex opcional)
                    <input v-model="form.recomendadorColor" placeholder="#ff00aa" />
                </label>

                <div class="modal-actions">
                    <button @click="submitNewItem">Salvar</button>
                    <button @click="closeModal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>